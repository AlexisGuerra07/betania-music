<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Meta b√°sicos -->
    <title>Betania Music - Sistema Musical Avanzado</title>
    <meta name="description" content="Sistema completo de gesti√≥n musical para acordes, letras y transposici√≥n autom√°tica - Equipo de Alabanza Betania">
    <meta name="keywords" content="m√∫sica, acordes, guitarra, alabanza, canciones, transposici√≥n, betania">
    <meta name="author" content="Equipo de Alabanza Betania">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#079b82">
    <meta name="background-color" content="#ffffff">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Betania Music">
    <link rel="apple-touch-icon" href="assets/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/icon-152x152.png">
    
    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icon-16x16.png">
    <link rel="shortcut icon" href="assets/icon-192x192.png">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Preload cr√≠tico -->
    <link rel="preload" href="script.js" as="script">
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üéµ</div>
            <h2>Betania Music</h2>
            <div class="loading-spinner"></div>
            <p>Cargando sistema musical...</p>
        </div>
    </div>

    <!-- Header principal -->
    <header class="app-header">
        <div class="header-content">
            <h1>üéµ Betania Music</h1>
            <p>Sistema Avanzado de Gesti√≥n Musical</p>
        </div>
        <button id="add-song-btn" class="add-song-btn">
            <span class="btn-icon">‚ûï</span>
            <span class="btn-text">A√±adir Canci√≥n</span>
        </button>
    </header>

    <!-- Contenido principal -->
    <div class="app-content">
        <!-- Vista principal -->
        <div id="main-view" class="main-view">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- B√∫squeda -->
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Buscar canciones..."
                        autocomplete="off"
                    >
                </div>
                
                <!-- Lista de canciones -->
                <div class="songs-list">
                    <h3 id="songs-count">Canciones (0)</h3>
                    <div id="songs-container" class="songs-container">
                        <!-- Las canciones se cargan din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="main-content">
                <!-- Pantalla de bienvenida -->
                <div id="welcome-screen" class="welcome-screen">
                    <div class="welcome-icon">üéµ</div>
                    <h2>Bienvenido a Betania Music</h2>
                    <p>Selecciona una canci√≥n para empezar o a√±ade una nueva</p>
                    <div class="welcome-features">
                        <div class="feature">
                            <span>üé∏</span>
                            <span>Transposici√≥n autom√°tica</span>
                        </div>
                        <div class="feature">
                            <span>üìù</span>
                            <span>Gesti√≥n de canciones</span>
                        </div>
                        <div class="feature">
                            <span>üîÆ</span>
                            <span>Detecci√≥n autom√°tica de partes</span>
                        </div>
                        <div class="feature">
                            <span>üíæ</span>
                            <span>Guardado autom√°tico</span>
                        </div>
                    </div>
                </div>

                <!-- Visor de canci√≥n -->
                <div id="song-viewer" class="song-viewer" style="display: none;">
                    <!-- Header de canci√≥n -->
                    <div class="song-header">
                        <div class="song-info">
                            <h2 id="song-title">T√≠tulo de la Canci√≥n</h2>
                            <p id="song-artist" class="song-artist">Artista</p>
                            <div class="key-info">
                                <span id="original-key" class="key-badge original">Original: C</span>
                                <span id="current-key" class="key-badge current">Actual: C</span>
                                <span id="transpose-info" class="transpose-info" style="display: none;">
                                    Transpuesta +0 semitonos
                                </span>
                            </div>
                        </div>
                        
                        <!-- Controles de transposici√≥n -->
                        <div class="transpose-controls">
                            <button id="transpose-down" class="transpose-btn" title="Bajar semitono">
                                <span>üîª ‚ô≠</span>
                            </button>
                            <select id="key-select" class="key-select" title="Seleccionar tonalidad">
                                <option value="C">C</option>
                                <option value="C#">C#</option>
                                <option value="D">D</option>
                                <option value="D#">D#</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F#</option>
                                <option value="G">G</option>
                                <option value="G#">G#</option>
                                <option value="A">A</option>
                                <option value="A#">A#</option>
                                <option value="B">B</option>
                            </select>
                            <button id="transpose-up" class="transpose-btn" title="Subir semitono">
                                <span>‚ôØ üî∫</span>
                            </button>
                            <button id="reset-key" class="reset-btn" title="Resetear a tonalidad original">
                                Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Secciones de la canci√≥n -->
                    <div id="song-sections" class="song-sections">
                        <!-- Las secciones se cargan din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario a√±adir canci√≥n CON DETECCI√ìN AUTOM√ÅTICA -->
        <div id="add-song-form" class="add-song-form" style="display: none;">
            <div class="form-header">
                <h2>‚ûï A√±adir Nueva Canci√≥n</h2>
                <button id="cancel-add" class="cancel-btn">‚úï</button>
            </div>
            
            <div class="form-content">
                <!-- Informaci√≥n b√°sica -->
                <div class="form-section">
                    <h3>Informaci√≥n B√°sica</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-title">T√≠tulo de la Canci√≥n *</label>
                            <input 
                                type="text" 
                                id="new-title" 
                                placeholder="Ej: Entrelazados"
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label for="new-artist">Artista</label>
                            <input 
                                type="text" 
                                id="new-artist" 
                                placeholder="Ej: Lucas Conslie"
                            >
                        </div>
                        <div class="form-group">
                            <label for="new-key">Tonalidad Original *</label>
                            <select id="new-key" required>
                                <option value="C">C</option>
                                <option value="C#">C#</option>
                                <option value="D">D</option>
                                <option value="D#">D#</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F#</option>
                                <option value="G">G</option>
                                <option value="G#">G#</option>
                                <option value="A">A</option>
                                <option value="A#">A#</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Bot√≥n de modo de detecci√≥n -->
                <div class="form-section">
                    <div class="detection-mode-toggle">
                        <button id="auto-detection-btn" onclick="toggleAutoDetection()" class="mode-toggle-btn">
                            üîÆ Detecci√≥n Autom√°tica
                        </button>
                        <p class="mode-description">
                            Cambia entre a√±adir secciones manualmente o pegar una canci√≥n completa para detecci√≥n autom√°tica
                        </p>
                    </div>
                </div>

                <!-- NUEVO: Secci√≥n de detecci√≥n autom√°tica -->
                <div id="auto-detection-section" class="form-section" style="display: none;">
                    <h3>üîÆ Detecci√≥n Autom√°tica de Partes</h3>
                    <div class="auto-detection-container">
                        <div class="form-group">
                            <label for="full-song-text">Pega la canci√≥n completa con acordes</label>
                            <textarea 
                                id="full-song-text" 
                                placeholder="Pega aqu√≠ la canci√≥n completa con sus acordes...

Ejemplos de formato que detecta:

CON ETIQUETAS:
Estrofa 1:
C         Am
Letra aqu√≠
F         G
M√°s letra

Coro:
F         C
Letra del coro
G         Am
Final del coro

SIN ETIQUETAS (detecta autom√°ticamente):
C         Am
Primera secci√≥n
F         G
Contenido aqu√≠

F         C
Segunda secci√≥n (probablemente coro)
G         Am
M√°s contenido

CONSEJOS:
- Separa las secciones con l√≠neas vac√≠as
- Usa etiquetas como 'Estrofa 1:', 'Coro:', 'Puente:'
- Incluye tanto acordes como letras"
                                rows="12"
                                oninput="processFullSongText()"
                            ></textarea>
                        </div>
                        
                        <!-- Vista previa de detecci√≥n -->
                        <div id="detection-preview" class="detection-preview">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n manual (original) -->
                <div id="manual-sections" class="form-section">
                    <h3>Secciones de la Canci√≥n</h3>
                    <div id="added-sections" class="added-sections">
                        <p class="no-sections">No hay secciones a√±adidas</p>
                    </div>
                </div>
                
                <!-- A√±adir secci√≥n manual -->
                <div id="manual-add-section" class="form-section add-section-form">
                    <h3>A√±adir Nueva Secci√≥n</h3>
                    <div class="form-group">
                        <label for="section-name">Nombre de la Secci√≥n</label>
                        <input 
                            type="text" 
                            id="section-name" 
                            placeholder="Ej: Estrofa 1, Coro, Puente, etc."
                        >
                    </div>
                    <div class="form-group">
                        <label for="section-content">Contenido (Acordes y Letras)</label>
                        <textarea 
                            id="section-content" 
                            placeholder="Ej:
C                    Am
Nada me apartar√° de ti
F                    G
Tu amor me sostiene aqu√≠

Tips:
- Pon los acordes sobre las letras
- Una l√≠nea por frase
- Usa espacios para alinear acordes"
                            rows="8"
                        ></textarea>
                    </div>
                    <button id="add-section-btn" class="add-section-btn">
                        A√±adir Secci√≥n
                    </button>
                </div>
                
                <!-- Acciones del formulario -->
                <div class="form-actions">
                    <button id="save-song-btn" class="save-btn">
                        üíæ Guardar Canci√≥n
                    </button>
                    <button id="cancel-form-btn" class="cancel-form-btn">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner de instalaci√≥n PWA -->
    <div id="install-banner" class="install-banner" style="display: none;">
        <div class="install-content">
            <div class="install-icon">üì±</div>
            <div class="install-text">
                <strong>¬°Instala Betania Music!</strong>
                <p>√ösala como una app nativa</p>
            </div>
            <div class="install-actions">
                <button id="install-button" class="install-btn">Instalar</button>
                <button id="install-dismiss" class="dismiss-btn">‚úï</button>
            </div>
        </div>
    </div>

    <!-- Banner de actualizaci√≥n -->
    <div id="update-banner" class="update-banner" style="display: none;">
        <div class="update-content">
            <span>üîÑ Nueva versi√≥n disponible</span>
            <button id="update-button" class="update-btn">Actualizar</button>
            <button id="update-dismiss" class="dismiss-btn">‚úï</button>
        </div>
    </div>

    <!-- Indicador offline -->
    <div id="offline-indicator" class="offline-indicator" style="display: none;">
        <span>üì° Sin conexi√≥n - Usando modo offline</span>
    </div>

    <!-- Script principal -->
    <script src="script.js"></script>
    
    <!-- PWA Registration Script -->
    <script>
        // Variables PWA
        let deferredPrompt;

        // Detectar instalaci√≥n
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        // Mostrar banner de instalaci√≥n
        function showInstallBanner() {
            const banner = document.getElementById('install-banner');
            if (banner) {
                banner.style.display = 'block';
                setTimeout(() => banner.classList.add('show'), 100);
            }
        }

        // Instalar app
        document.getElementById('install-button')?.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            deferredPrompt = null;
            document.getElementById('install-banner').style.display = 'none';
        });

        // Cerrar banner
        document.getElementById('install-dismiss')?.addEventListener('click', () => {
            document.getElementById('install-banner').style.display = 'none';
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('‚úÖ SW registrado:', registration.scope);
                    
                    // Manejar actualizaciones
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateBanner();
                            }
                        });
                    });
                } catch (error) {
                    console.error('‚ùå Error registrando SW:', error);
                }
            });
        }

        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.style.display = 'block';
                setTimeout(() => banner.classList.add('show'), 100);
            }
        }

        // Manejar actualizaci√≥n
        document.getElementById('update-button')?.addEventListener('click', () => {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        });

        // Estado de conexi√≥n
        function updateOnlineStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (navigator.onLine) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'block';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Ocultar loading screen
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        });
    </script>
</body>
</html>
